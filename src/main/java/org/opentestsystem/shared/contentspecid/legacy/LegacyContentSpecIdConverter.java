package org.opentestsystem.shared.contentspecid.legacy;

import org.opentestsystem.shared.contentspecid.ContentSpecId;
import org.opentestsystem.shared.contentspecid.ContentSpecIdBuilder;
import org.opentestsystem.shared.contentspecid.ContentSpecIdConverter;
import org.opentestsystem.shared.contentspecid.enums.ContentSpecFormat;
import org.opentestsystem.shared.contentspecid.enums.ContentSpecGrade;
import org.opentestsystem.shared.contentspecid.enums.ContentSpecSubject;
import org.opentestsystem.shared.contentspecid.enums.DomainCode;
import org.opentestsystem.shared.contentspecid.exceptions.ValidationException;

import javax.annotation.Nonnull;

import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.opentestsystem.shared.contentspecid.exceptions.ErrorSeverity.INVALID;
import static org.opentestsystem.shared.contentspecid.handlers.DomainHandler.formatDashedDomain;

/**
 * ContentSpecIdConverter between ID strings and objects. It has parse methods that take strings in the
 * enhanced CSID format type or any of the four legacy format types and turn them into ContentSpecId object.
 * It also has format methods to convert the objects back into strings.
 *
 * <p>
 *     The content specification syntax defines an enhanced format and four legacy formats for specifying
 *     a content specification as a string. Examples of each format are shown below:
 *     <ul>
 *         <li>Enhanced examples for ELA and Math: E.G3.C1RI.T11.RI.3.9, M.G8.C1EE.TB.8.EE.A.2</li>
 *         <li>Legacy ELA v1 example: SBAC-ELA-v1:1-IT|9-3|3.RI.2</li>
 *         <li>Legacy Math v4 example: SBAC-MA-v4:1|G|K-3|a/s|3.G.2</li>
 *         <li>Legacy Math v5 example: SBAC-MA-v5:1|OA|A-3|m|3.OA.2</li>
 *         <li>Legacy Math v6 example:  SBAC-MA-v6:1|P|TS02|D-3</li>
 *     </ul>
 *     @see <a href="http://www.smarterapp.org/documents/ContentSpecificationIdFormats.pdf">Content Specification ID Formats (PDF)</a>
 * </p>
 **/
public class LegacyContentSpecIdConverter extends ContentSpecIdConverter {
    private static final ContentSpecFormat DEFAULT_ELA_FORMAT = ContentSpecFormat.ELA_V1;
    private static final ContentSpecFormat DEFAULT_MATH_FORMAT = ContentSpecFormat.MATH_V4;

    @Override
    public ContentSpecFormat getFormatType(@Nonnull final String csid) throws ValidationException {
        String idString = cleanInput(csid);

        for (ContentSpecFormat format: ContentSpecFormat.values()) {
            if (format.isLegacy() && idString.startsWith(format.getLegacyPrefix())) {
                return format;
            }
        }

        throw new ValidationException(INVALID, String.format("Unknown ID format: '{%s}'.", idString));
    }

    @Override
    public ContentSpecId parse(String input, ContentSpecGrade defaultGrade) throws ValidationException {
        final ContentSpecFormat format = getFormatType(input);
        final String idString = cleanInput(input);

        int prefixLength = format.getLegacyPrefix().length();

        ContentSpecSubject subject;
        if (format == ContentSpecFormat.ELA_V1) {
            subject = ContentSpecSubject.ELA;
        } else {
            subject = ContentSpecSubject.MATH;
        }

        final String[] parts = idString.substring(prefixLength).split("\\|");

        ContentSpecGrade grade = defaultGrade;
        String parseGrade = parseGrade(format, parts);
        if (ContentSpecGrade.fromString(parseGrade) != ContentSpecGrade.UNSPECIFIED) {
            grade = ContentSpecGrade.fromString(parseGrade);
        }

        ContentSpecIdBuilder builder = ContentSpecIdBuilder.getBuilder(subject, grade);

        switch (format) {
            case ELA_V1:
                if (parts.length > 0) {
                    int dash = parts[0].indexOf('-');
                    if (dash >= 0) {
                        builder.claim(parts[0].substring(0, dash));
                        builder.domain(parts[0].substring(dash + 1));
                    } else {
                        builder.claim(parts[0]);
                    }
                }

                if (parts.length > 1) {
                    int dash = parts[1].indexOf('-');
                    if (dash >= 0) {
                        builder.target(parts[1].substring(0, dash));
                    } else {
                        builder.target(parts[1]);
                    }
                }

                if (parts.length > 2) {
                    builder.ccss(parts[2]);
                }

                break;

            case MATH_V4:
            case MATH_V5:
                if (parts.length > 0) {
                    builder.claim(parts[0]);
                }

                if (parts.length > 1) {
                    builder.domain(parts[1]);
                }

                if (parts.length > 2) {
                    int dash = parts[2].indexOf('-');
                    if (dash >= 0) {
                        builder.target(parts[2].substring(0, dash));
                    } else {
                        builder.target(parts[2]);
                    }
                }

                if (parts.length > 3) {
                    builder.emphasis(parts[3]);
                }

                if (parts.length > 4) {
                    builder.ccss(parts[4]);
                }

                break;

            case MATH_V6:
                String claim = "";
                if (parts.length > 0) {
                    claim = parts[0];
                    builder.claim(claim);
                }

                if (parts.length > 1) {
                    if (claim.equals("1")) {
                        builder.contentCategory(parts[1]);
                    } else {
                        builder.domain(parts[1]);
                    }
                }

                if (parts.length > 3) {
                    int dash = parts[3].indexOf('-');
                    if (dash >= 0) {
                        builder.target(parts[3].substring(0, dash));
                    } else {
                        builder.target(parts[3]);
                    }
                }

                break;

            default:
                throw new ValidationException(INVALID, String.format("Unknown ID format: '{%s}'.", idString));
        }

        return builder.build();
    }

    private String parseGrade(ContentSpecFormat format, String[] parts) {
        int part = -1;
        switch (format) {
            case ELA_V1:
                part = 1;
                break;
            case MATH_V4:
            case MATH_V5:
                part = 2;
                break;
            case MATH_V6:
                part = 3;
                break;
        }

        if (part >= 0 && part < parts.length) {
            int dash = parts[part].indexOf('-');
            if (dash >= 0) {
                return parts[part].substring(dash + 1);
            }
        }

        return null;
    }

    @Override
    public String format(ContentSpecId id) throws ValidationException {
        if (id.isMath()) {
            return format(id, DEFAULT_MATH_FORMAT);
        }
        if (id.isEla()) {
            return format(id, DEFAULT_ELA_FORMAT);
        }

        return "";
    }

    @Override
    public String format(ContentSpecId id, ContentSpecFormat format) throws ValidationException {
        validator.validateFor(id, format);

        String idString;

        switch (format) {
            case ENHANCED:
                throw new IllegalArgumentException("Legacy Formatter cannot handle ENHANCED format");

            case ELA_V1:
                idString = String.format("SBAC-ELA-v1:%s-%s|%s-%s",
                        id.getClaim().getLegacyValue(),
                        getLegacyDomain(id.getDomain()),
                        id.getTarget(),
                        id.getGrade().getLegacyValue());

                if (isNotBlank(id.getCcss())) {
                    idString += ("|" + id.getCcss());
                }

                break;

            case MATH_V4:
            case MATH_V5:
                idString = String.format("SBAC-MA-v%d:%s|%s|%s-%s|%s",
                        format.getValue(),
                        id.getClaim().getLegacyValue(),
                        formatDashedDomain(getLegacyDomain(id.getDomain()), id.getGrade(), id.getCcss()),
                        id.getTarget(),
                        id.getGrade().getLegacyValue(),
                        id.getEmphasis().getValue());

                if (isNotBlank(id.getCcss())) {
                    idString += ("|" + id.getCcss());
                }

                break;

            case MATH_V6:
                idString = String.format("SBAC-MA-v6:%s|%s|%s|%s-%s",
                        id.getClaim().getLegacyValue(),
                        id.getContentCategory(),
                        formatTargetSet(id.getTargetSet()),
                        id.getTarget(),
                        id.getGrade().getLegacyValue());
                break;

            default:
                idString = "";
        }

        return idString;
    }

    private String formatTargetSet(int ts) {
        return (ts == 0) ? NOT_APPLICABLE : String.format("TS%02d", ts);
    }

    private String getLegacyDomain(String domain) {
        DomainCode code = DomainCode.fromString(domain);
        if (code == DomainCode.UNK) {
            return domain;
        }

        return code.getLegacyValue();
    }
}