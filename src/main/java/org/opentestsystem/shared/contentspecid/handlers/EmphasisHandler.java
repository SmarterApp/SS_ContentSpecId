package org.opentestsystem.shared.contentspecid.handlers;

import org.opentestsystem.shared.contentspecid.enums.ContentSpecEmphasis;
import org.opentestsystem.shared.contentspecid.enums.ContentSpecGrade;

import java.util.HashMap;
import java.util.Map;

import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.opentestsystem.shared.contentspecid.handlers.TargetHandler.BAD_TARGET_VALUE;
import static org.opentestsystem.shared.contentspecid.handlers.TargetHandler.getMathTargetChar;

/**
 * Handler for functions relating to the emphasis contained in an ID.
 */
public class EmphasisHandler {
    private static final Map<ContentSpecGrade, boolean []> MATH_EMPHASIS_MAP = new HashMap<>();

    static {
        // Populate emphases for grades 3 through 8 for targets 1 - 12 plus high school with arrays for targets 1 - 16
        MATH_EMPHASIS_MAP.put(ContentSpecGrade.G3,
                new boolean[] {  true,  true,  true,  true, false,  true,  true, false,  true, false, false, false });
        MATH_EMPHASIS_MAP.put(ContentSpecGrade.G4,
                new boolean[] {  true, false, false,  true,  true,  true,  true,  true, false, false, false, false });
        MATH_EMPHASIS_MAP.put(ContentSpecGrade.G5,
                new boolean[] { false, false,  true,  true,  true,  true, false, false,  true, false, false, false });
        MATH_EMPHASIS_MAP.put(ContentSpecGrade.G6,
                new boolean[] {  true,  true, false,  true,  true,  true,  true, false, false, false, false, false });
        MATH_EMPHASIS_MAP.put(ContentSpecGrade.G7,
                new boolean[] {  true,  true,  true,  true, false, false, false, false, false, false, false, false });
        MATH_EMPHASIS_MAP.put(ContentSpecGrade.G8,
                new boolean[] { false,  true,  true,  true,  true,  true,  true,  true, false, false, false, false });
        MATH_EMPHASIS_MAP.put(ContentSpecGrade.GHS,
                new boolean[] { false, false, false, true, true, true, true, true, true, true, true, true,
                        true, true, false, false });
    }

    /**
     * Computes the emphasis of an ID based on grade, target, and in one edge case, ccss. This method is only
     * relevant for IDs that have subject Math and Claim C1.
     *
     * @param grade the grade level 1 - 12, K or HS
     * @param target the IDs target code
     * @param ccss the ccss information used in one special case
     *
     * @return ContentSpecEmphasis, with the default AS.
     */
    public ContentSpecEmphasis computeEmphasis(ContentSpecGrade grade, String target, String ccss) {
        ContentSpecEmphasis emphasis = ContentSpecEmphasis.AS;

        char targetChar = getMathTargetChar(target);
        if (targetChar != BAD_TARGET_VALUE && MATH_EMPHASIS_MAP.containsKey(grade)) {
            int index  = targetChar - 'A';
            boolean[] emphasisByGrade = MATH_EMPHASIS_MAP.get(grade);
            if (index >= 0 && index < emphasisByGrade.length) {
                emphasis = emphasisByGrade[index] ? ContentSpecEmphasis.M : ContentSpecEmphasis.AS;

                if (targetChar == 'O' && isNotBlank(ccss) && !ccss.startsWith("G-SRT")) {
                    // This is an odd case. Sometimes when recording secondary alignment to a CCSS
                    // standard that's not referenced in teh content specification, staff have used
                    // a target of "O" for "Other". Usually, and preferably, they have used a target
                    // of "X". The trouble with "O" is that it's a legitimate target and is "m"
                    // whereas other alignments should be "a/s". We solve this by looking at the CCSS
                    // alignment. If it does not start with "G-SRT" which is the proper standard for
                    // target "O" then we set the emphasis to "a/s".
                    emphasis = ContentSpecEmphasis.AS;
                }
            }
        }

        return emphasis;
    }
}
