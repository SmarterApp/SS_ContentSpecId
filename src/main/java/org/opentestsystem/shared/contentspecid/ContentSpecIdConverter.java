package org.opentestsystem.shared.contentspecid;

import org.opentestsystem.shared.contentspecid.enums.ContentSpecClaim;
import org.opentestsystem.shared.contentspecid.enums.DomainCode;
import org.opentestsystem.shared.contentspecid.exceptions.ErrorSeverity;
import org.opentestsystem.shared.contentspecid.exceptions.IdParseException;
import org.opentestsystem.shared.contentspecid.exceptions.IdValidationException;
import org.opentestsystem.shared.contentspecid.legacy.LegacyContentSpecIdConverter;
import org.opentestsystem.shared.contentspecid.enums.ContentSpecGrade;
import org.opentestsystem.shared.contentspecid.enums.ContentSpecFormat;
import org.opentestsystem.shared.contentspecid.enums.ContentSpecSubject;

import javax.annotation.Nonnull;
import java.util.Arrays;
import java.util.stream.Collectors;

import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.opentestsystem.shared.contentspecid.enums.ContentSpecFormat.ENHANCED;

/**
 * ContentSpecIdConverter between ID strings and objects. It has parse methods that take strings in the
 * enhanced CSID format type or any of the four legacy format types and turn them into ContentSpecId object.
 * It also has format methods to convert the objects back into strings.
 */
public class ContentSpecIdConverter {
    // Lazy loaded via getLegacyConverter()
    private LegacyContentSpecIdConverter legacyConverter = null;
    protected ContentSpecIdValidator validator = new ContentSpecIdValidator();

    protected static final String NOT_APPLICABLE = "NA";

    public ContentSpecFormat getFormatType(@Nonnull final String input) throws IdParseException {
        String idString = cleanInput(input);

        if (idString.startsWith("E") || idString.startsWith("M")) {
            return ENHANCED;
        } else {
            return getLegacyConverter().getFormatType(idString);
        }
    }

    @SuppressWarnings("WeakerAccess")
    public ContentSpecId parse(String input) throws IdParseException {
        return parse(input, ContentSpecGrade.UNSPECIFIED);
    }


    public ContentSpecId parse(String input, ContentSpecGrade grade) throws IdParseException {
        if (getFormatType(input).isLegacy()) {
            return getLegacyConverter().parse(input, grade);
        }

        final String idString = cleanInput(input);

        String[] parts = idString.split("\\.");

        if (parts.length < 2) {
            throw new IdParseException(ErrorSeverity.INVALID, "ID must contain at least subject and grade");
        }

        ContentSpecSubject subject = convertSubject(parts[0]);
        String gradeString = parts[1];

        ContentSpecIdBuilder builder =
                ContentSpecIdBuilder.getBuilder(subject, ContentSpecGrade.fromString(gradeString));

        if (parts.length > 2) {
            if (parts[2].length() <= 2) {
                builder.claim(parts[2])
                        .domain("");
            } else {
                builder.claim(parts[2].substring(0, 2))
                        .domain(parts[2].substring(2));
            }
        }

        if (parts.length > 3) {
            builder.target(parts[3]);
            if (parts[3] != null && parts[3].length() > 1 && parts[3].startsWith("T")) {
                // Target string is all characters following the "T" prefix
                builder.target(parts[3].substring(1));
            } else {
                throw new IdParseException(ErrorSeverity.INVALID,
                        String.format("Expected non-empty target in ID but found '%s'.", parts[3]));
            }
        }

        if (parts.length > 4) {
            String ccss = Arrays.stream(parts)
                    .skip(4)
                    .collect(Collectors.joining("."));
            if (isBlank(ccss)) {
                throw new IdParseException(ErrorSeverity.INVALID, "CCSS must not be empty.");
            }
            builder.ccss(ccss);
        }

        return builder.build();
    }

    public String format(ContentSpecId id) throws IdValidationException {
        return format(id, ENHANCED);
    }

    public String format(ContentSpecId id, ContentSpecFormat format) throws IdValidationException {
        validator.validateFor(id, format);

        if (!(id.isEla() || id.isMath())) {
            return "";
        }

        if (format.isUnknown()) {
            return "";
        }

        if (format.isLegacy()) {
            return getLegacyConverter().format(id, format);
        }

        StringBuilder sb = new StringBuilder();
        sb.append(id.isEla() ? 'E' : 'M');

        if (id.getGrade() != ContentSpecGrade.UNSPECIFIED) {
            sb.append('.').append(id.getGrade().getValue()); // Includes the 'G' prefix

            if (id.getClaim() != ContentSpecClaim.UNSPECIFIED) {
                sb.append('.').append(id.getClaim().getValue()); // Includes the 'C' prefix

                // Either Conceptual category (High School) or Domain (Grades 3-8)
                DomainCode domain = DomainCode.fromString(id.getDomain());
                if (domain != DomainCode.NA) {
                    sb.append(domain == DomainCode.UNK ? id.getDomain() : domain.getValue());
                }

                if (isNotBlank(id.getTarget())) {
                    sb.append(".T").append(id.getTarget());

                    if (isNotBlank(id.getCcss())) {
                        sb.append('.').append(id.getCcss());
                    }
                }
            }
        }

        return sb.toString();
    }

    @SuppressWarnings("WeakerAccess")
    public String formatLegacy(ContentSpecId id) throws IdValidationException {
        return getLegacyConverter().format(id);
    }

    private ContentSpecSubject convertSubject(final String subject) throws IdParseException {
        switch (subject) {
            case "E":
                return ContentSpecSubject.ELA;
            case "M":
                return ContentSpecSubject.MATH;
        }

        throw new IdParseException(ErrorSeverity.INVALID,
                String.format("Subject must be 'E' or 'M'; found '%s'", subject));
    }

    protected static String cleanInput(final String input) throws IdParseException {
        if (isBlank(input)) {
            throw new IdParseException(ErrorSeverity.INVALID, "Cannot process a blank ID");
        }

        return input.trim();
    }

    private LegacyContentSpecIdConverter getLegacyConverter() {
        if (legacyConverter == null) {
            legacyConverter = new LegacyContentSpecIdConverter();
        }

        return legacyConverter;
    }
}
